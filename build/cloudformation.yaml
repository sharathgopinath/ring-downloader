AWSTemplateFormatVersion: '2010-09-09'
Transform: "AWS::Serverless-2016-10-31"
Description: ring-downloader

Parameters:
  BranchName:
    Type: String
    Description: Name of the branch.

Conditions:
  IsProd: !Equals [!Ref BranchName, 'main']

Resources:
  RingCredentials:
    Type: AWS::SecretsManager::Secret
    Properties:
      Description: Credentials to access ring account
      Name: RingCredentials
      SecretString:
        "{\"username\": \"replace-me\", \"password\": \"replace-me\"}"

  DownloaderFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: 
        !If [ IsProd, 'ring-downloader', !Sub 'ring-downloader-${BranchName}' ]
      Description: Downloads ring videos
      Runtime: python3.8
      CodeUri: ./packages/init.py
      Handler: init.lambda_handler
      MemorySize: 128
      Timeout: 20
      Policies:
        - AWSSecretsManagerGetSecretValuePolicy:
            SecretArn: !Ref RingCredentials