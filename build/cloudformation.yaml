AWSTemplateFormatVersion: '2010-09-09'
Transform: "AWS::Serverless-2016-10-31"
Description: ring-downloader

Parameters:
  BranchName:
    Type: String
    Description: Name of the branch.
  ImageUri:
    Type: String
    Description: Container image uri

Conditions:
  IsProd: !Equals [!Ref BranchName, 'main']

Resources:
  RingCredentials:
    Type: AWS::SecretsManager::Secret
    Properties:
      Description: Credentials to access ring account
      Name: RingCredentials
      SecretString:
        "{\"username\": \"replace-me\", \"password\": \"replace-me\", \"token\": \"replace-me\"}"

  DownloaderFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: 
        !If [ IsProd, 'ring-downloader', !Sub 'ring-downloader-${BranchName}' ]
      Description: Downloads ring videos
      PackageType: Image
      ImageUri : !Ref ImageUri
      MemorySize: 128
      Timeout: 20
      Policies:
        - AWSSecretsManagerGetSecretValuePolicy:
            SecretArn: !Ref RingCredentials
      Events:
        ScheduleEvent:
          Type: Schedule
          Properties:
            Schedule: 'rate(30 minutes)'
            Name: RingDownloadSchedule
            Description: Download schedule
            Enabled: true

  LogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Ref DownloaderFunction
      RetentionInDays: 14